#!/bin/sh
## Takes one parameter for the name of the certificate and creates 
## a private certificate and an certification signing request both in PEM
## format

# Read the default from the CSR default configuration file
source csr-default.conf

usage () {
    >&2 echo "usage:"
    >&2 echo "$0 <key-name> <C> <ST> <L> <O> <OU> <CN> <mail>"
    exit 1
}

if [ ! -f CA/key.pem ]; then
    >&2 echo "The CA is not initialized!"
    exit 1
fi

if [ -z "$1" ]; then
    usage
    exit 2
fi

export KEY_FILE="./$1.key.pem"
export CSR_FILE="./$1.csr.pem"

# Create the private key
openssl genrsa -aes256 -out "$KEY_FILE" 

retVal=$?
if [ $retVal -eq 0 ]; then
    echo "RSA key '$KEY_FILE' created."
fi

# Create the CSR, using the just created private key
openssl req -new -sha256 \
    -subj "/C=$2/ST=$3/L=$4/O=$5/OU=$6/CN=$7/emailAddress=$8" \
    -addext "subjectAltName = DNS:test.de" \
    -key "$KEY_FILE" -out "$CSR_FILE"

retVal=$?
if [ $retVal -eq 0 ]; then
    echo "CSR '$1.csr.pem' created."
fi
